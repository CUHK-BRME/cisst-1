#
# $Id$
#

# (C) Copyright 2005-2007 Johns Hopkins University (JHU), All Rights
# Reserved.

# --- begin cisst license - do not edit ---
#
# This software is provided "as is" under an open source license, with
# no warranty.  The complete license can be found in license.txt and
# http://www.cisst.org/cisst/license.txt.
#
# --- end cisst license ---

# CMakeLists.txt for cisstNumerical wrapping tests

# Keep a list all tests for ctest/Dart
SET(DART_TEST_FILE ${CMAKE_CURRENT_BINARY_DIR}/DartTestfile-cisstVectorPython.txt)
SET(DART_TEST_FILE_AUTO ${CMAKE_CURRENT_BINARY_DIR}/DartTestfile-cisstVectorPython-auto.txt)
FILE(WRITE ${DART_TEST_FILE} "# File generated by CMake, do not modify\n")


# Wrap C++ class used to test the wrapping of fixed size vectors
# Swig requirements
FIND_PACKAGE(SWIG REQUIRED)
INCLUDE(${SWIG_USE_FILE})
INCLUDE_DIRECTORIES("C:/Python25/Lib/site-packages/numpy/core/include/numpy")
# Python libraries
IF(WIN32)
  LINK_LIBRARIES(debug ${PYTHON_DEBUG_LIBRARIES} optimized ${PYTHON_LIBRARIES})
ELSE(WIN32)
  LINK_LIBRARIES(${PYTHON_LIBRARIES})
ENDIF(WIN32)

# Threads for Python
FIND_PACKAGE(Threads REQUIRED)

# Allow generated c++ code to find header files
INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR})
INCLUDE_DIRECTORIES(${CISST_SWIG_INCLUDE_DIR})

# We are using C++ code
SET(PROXY_TESTS vctDynamicVectorTypemapsTest vctFixedSizeVectorTypemapsTest vctDynamicMatrixTypemapsTest vctFixedSizeMatrixTypemapsTest vctDynamicNArrayTypemapsTest)
FOREACH(proxyTest ${PROXY_TESTS})
  SET(interface ${CMAKE_CURRENT_SOURCE_DIR}/${proxyTest}.i)
  SET(module ${proxyTest}Python)
  SET(TEST_PROGRAMS ${TEST_PROGRAMS} ${proxyTest}.py)

  SET_SOURCE_FILES_PROPERTIES(${interface} PROPERTIES CPLUSPLUS ON)
  SET_SOURCE_FILES_PROPERTIES(${interface}
                            PROPERTIES SWIG_FLAGS "-v;-modern;-fvirtual")
#                           PROPERTIES SWIG_FLAGS "-v;-modern;-fcompact;-fvirtual")
  SWIG_ADD_MODULE(${module} python ${interface})
  IF(WIN32)
    SWIG_LINK_LIBRARIES(${module}
                        cisstVector cisstCommon
                        debug ${PYTHON_DEBUG_LIBRARIES}
                        optimized ${PYTHON_LIBRARIES})
    SET_TARGET_PROPERTIES(_${module} PROPERTIES SUFFIX .pyd)
  ELSE(WIN32)
    SWIG_LINK_LIBRARIES(${module} cisstVector cisstCommon ${PYTHON_LIBRARIES})
  ENDIF(WIN32)
  # Copy the .py file generated to wherever the libraries are
  ADD_CUSTOM_COMMAND(TARGET _${module}
                     POST_BUILD
                     COMMAND ${CMAKE_COMMAND}
                     ARGS -E copy
                             ${CMAKE_CURRENT_BINARY_DIR}/${module}.py
                             ${LIBRARY_OUTPUT_PATH}/${CMAKE_CFG_INTDIR}/${module}.py)
  # Create a cisstCommon.py as CMake assumes one should be created
  # This is a bug that should be fixed in future releases of CMake.
  ADD_CUSTOM_COMMAND(TARGET _${module}
                     POST_BUILD
                     COMMAND ${CMAKE_COMMAND}
                     ARGS -E copy
                             ${CMAKE_CURRENT_BINARY_DIR}/${module}.py
                             ${CMAKE_CURRENT_BINARY_DIR}/${proxyTest}.py)
ENDFOREACH(proxyTest)

# Create the scripts from .in
SET(LIB cisstVector)
IF(CMAKE_CONFIGURATION_TYPES)
  FOREACH(config ${CMAKE_CONFIGURATION_TYPES})
    CONFIGURE_FILE(${cisstWrappingTests_SOURCE_DIR}/cisstTestMain.py.in
                   ${EXECUTABLE_OUTPUT_PATH}/${config}/cisstVectorTests.py
                   IMMEDIATE @ONLY@)
  ENDFOREACH(config)
ELSE(CMAKE_CONFIGURATION_TYPES)
  CONFIGURE_FILE(${cisstWrappingTests_SOURCE_DIR}/cisstTestMain.py.in
                 ${EXECUTABLE_OUTPUT_PATH}/cisstVectorTests.py
                 IMMEDIATE @ONLY@)
ENDIF(CMAKE_CONFIGURATION_TYPES)

# Run the script to generate the list of tests automatically
ADD_CUSTOM_TARGET(cisstVector_CREATE_PYTHON_TESTS_LIST ALL
                  COMMAND ${PYTHON_EXECUTABLE} ${EXECUTABLE_OUTPUT_PATH}/${CMAKE_CFG_INTDIR}/cisstVectorTests.py -d ${PYTHON_EXECUTABLE} > ${DART_TEST_FILE_AUTO}
                  SOURCES ${TEST_PROGRAMS})

ADD_DEPENDENCIES(cisstVector_CREATE_PYTHON_TESTS_LIST
                 cisstCommon
                 cisstVector
                 _cisstCommonPython
                 _cisstVectorPython
                 _vctDynamicVectorTypemapsTestPython
                 _vctFixedSizeVectorTypemapsTestPython
                 _vctDynamicMatrixTypemapsTestPython
                 _vctFixedSizeMatrixTypemapsTestPython
                 _vctDynamicNArrayTypemapsTestPython)

FILE(APPEND ${DART_TEST_FILE} "INCLUDE(\"${DART_TEST_FILE_AUTO}\")\n")


# Add all the test lists
SET_DIRECTORY_PROPERTIES(PROPERTIES TEST_INCLUDE_FILE
                         ${DART_TEST_FILE})


